apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv
spec:
  capacity:
    storage: 10Gi  # 定义存储大小
  volumeMode: Filesystem  # 默认为文件系统
  storageClassName: standard
  local:
    path: /mnt/data/mysql
  accessModes:
    - ReadWriteOnce  
  persistentVolumeReclaimPolicy: Retain  # PV 被释放时保留数据
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - master
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv-node1
spec:
  capacity:
    storage: 10Gi  # 定义存储大小
  volumeMode: Filesystem  # 默认为文件系统
  storageClassName: standard
  local:
    path: /mnt/data/mysql
  accessModes:
    - ReadWriteOnce  
  persistentVolumeReclaimPolicy: Retain  # PV 被释放时保留数据
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node1
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv-node4
spec:
  capacity:
    storage: 10Gi  # 定义存储大小
  volumeMode: Filesystem  # 默认为文件系统
  storageClassName: standard
  local:
    path: /mnt/data/mysql
  accessModes:
    - ReadWriteOnce  
  persistentVolumeReclaimPolicy: Retain  # PV 被释放时保留数据
  nodeAffinity:
    required:
      nodeSelectorTerms:
        - matchExpressions:
            - key: kubernetes.io/hostname
              operator: In
              values:
                - node4
---

apiVersion: v1
kind: Namespace
metadata:
  name: mysql
---
#Secret mysql密码
apiVersion: v1
kind: Secret
metadata:
  name: mysql-pass
  namespace: mysql
type: Opaque
data:
  password: bXlzcWxfcm9vdF8xMjNAMTEyLi4=  # Base64 编码后的密码
---
#Service 暴露端口 3306
apiVersion: v1
kind: Service
metadata:
  name: mysql-master
  namespace: mysql
  labels:
    app: mysql
    role: master # 增加角色标签
spec:
  ports:
    - port: 3306
      targetPort: 3306
  selector:
    app: mysql
    role: master # 仅选择主节点
  type: NodePort
---
#Service 暴露端口 3306
apiVersion: v1
kind: Service
metadata:
  name: mysql-slave
  namespace: mysql
  labels:
    app: mysql
    role: slave # 增加角色标签
spec:
  ports:
    - port: 3306
  selector:
    app: mysql
    role: slave  # 仅选择从节点
  type: NodePort

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
  namespace: mysql
data:
  my.cnf: |
    [client]
    default-character-set=utf8
    [mysql]
    default-character-set=utf8
    [mysqld]
    init_connect='SET collation_connection = utf8_unicode_ci'
    init_connect='SET NAMES utf8'
    character-set-server=utf8
    collation-server=utf8_unicode_ci
    skip-character-set-client-handshake
    skip-name-resolve
    server_id=1
    log-bin=mysql-bin
    read-only=0
    replicate-ignore-db=mysql
    replicate-ignore-db=sys
    replicate-ignore-db=information_schema
    replicate-ignore-db=performance_schema
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-slave-config
  namespace: mysql
data:
  my.cnf: |
    [mysqld]
    server-id=1000   # 占位符，将被启动脚本替换
    relay-log=relay-bin  # 启用中继日志，用于从服务器记录从主服务器复制过来的事件
    log-bin=binlog  # 启用二进制日志，以便从服务器可以记录复制过程中的事件
    read-only=1  # 设置从服务器为只读，以防止直接修改从服务器的数据
    skip-slave-start=1  # 防止从服务器启动时自动开始复制
---
apiVersion: apps/v1 #必选，版本号，例如v1
kind: StatefulSet  #必选，资源类型，例如 Pod
metadata: #必选，元数据
  name: mysql-master #必选，Pod名称
  namespace: mysql
  labels: #自定义标签列表
    app: mysql
    role: master
spec: #必选，Pod中容器的详细定义
  serviceName: "mysql-master"
  replicas: 1 #Pod数量
  selector: #选择器
    matchLabels: #匹配标签
      app: mysql
      role: master
  template:
    metadata:
      labels:
        app: mysql
        role: master
    spec:
      containers: #必选，Pod中容器列表
        - name: mysql   #必选，容器名称
          image: mysql:8.4.4  #必选，容器的镜像名称
          imagePullPolicy: IfNotPresent  #获取镜像的策略
          volumeMounts: #挂载到容器内部的存储卷配置
            - name: mysql-pv #引用pod定义的共享存储卷的名称，需用volumes[]部分定义的的卷名
              mountPath: /var/lib/mysql #存储卷在容器内mount的绝对路径，应少于512字符
              readOnly: false #是否为只读模式
            - name: config
              mountPath: /etc/mysql/conf.d/
          ports: #需要暴露的端口库号列表
            - name: mysql        #端口的名称
              containerPort: 3306  #容器需要监听的端口号
              protocol: TCP #端口协议，支持TCP和UDP，默认TCP
          env: #容器运行前需设置的环境变量列表
            - name: TZ
              value: "Asia/Shanghai"  # 设置时区为上海
            - name: MYSQL_ROOT_PASSWORD #环境变量名称
              valueFrom: #环境变量的值
                secretKeyRef:
                  name: mysql-pass
                  key: password # root 用户密码
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          command: [ "sh", "-c" ]
          args:
            - |
         
              echo "MySQL is up and running. Creating replication user..."
              
              # 创建复制用户
              mysql -uroot -p$MYSQL_ROOT_PASSWORD -e "
                CREATE USER 'repl_user'@'%' IDENTIFIED WITH mysql_native_password BY '${MYSQL_ROOT_PASSWORD}';
                GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';
              "
              
              # 正常启动MySQL
              exec mysqld
          resources: #资源限制和请求的设置
            limits: #资源限制的设置
              cpu: "1" #Cpu的限制，单位为core数，将用于docker run --cpu-shares参数
              memory: "2Gi"  #内存限制，单位可以为Mib/Gib，将用于docker run --memory参数
          livenessProbe: #对Pod内各容器健康检查的设置，当探测无响应几次后将自动重启该容器
            tcpSocket: #对Pod内个容器健康检查方式设置为tcpSocket方式
              port: 3306
            initialDelaySeconds: 30 #容器启动完成后首次探测的时间，单位为秒
            timeoutSeconds: 5 #对容器健康检查探测等待响应的超时时间，单位秒，默认1秒
            periodSeconds: 10 #对容器监控检查的定期探测时间设置，单位秒，默认10秒一次
            successThreshold: 1
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: 3306
            initialDelaySeconds: 5
            periodSeconds: 10
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
      restartPolicy: Always  #Pod的重启策略
      volumes:
        - name: config
          configMap:
            name: mysql-config
      nodeSelector:
        kubernetes.io/hostname: master #设置NodeName表示将该Pod调度到指定到名称的node节点上
      hostNetwork: false   #是否使用主机网络模式，默认为false，如果设置为true，表示使用宿主机网络
  volumeClaimTemplates:
    - metadata:
        name: mysql-pv
      spec:
        storageClassName: "standard"
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 10Gi
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql-slave
  namespace: mysql
  labels:
    app: mysql
    role: slave
spec:
  serviceName: "mysql-slave"
  replicas: 2
  selector:
    matchLabels:
      app: mysql
      role: slave  # 匹配Pod标签
  template:
    metadata:
      labels:
        app: mysql
        role: slave  # 关键标签
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchLabels:
                  app: redis
              topologyKey: kubernetes.io/hostname
      containers:
        - name: mysql
          image: mysql:8.4.4
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: mysql-slave-pv
              mountPath: /var/lib/mysql
            - name: config
              mountPath: /etc/mysql/conf.d_template/  # 挂载到临时目录
          ports:
            - containerPort: 3306
          env:
            - name: TZ
              value: "Asia/Shanghai"  # 设置时区为上海
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-pass
                  key: password
            - name: MASTER_HOST
              value: "mysql-master.dev.svc.cluster.local"
            - name: MASTER_USER
              value: "repl_user"
            - name: MASTER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-pass
                  key: password
          command: [ "sh", "-c" ]
          args:
            - |
              # 将配置文件复制到可写目录
              mkdir -p /etc/mysql/conf.d/
              cp /etc/mysql/conf.d_template/* /etc/mysql/conf.d/

              # 获取Pod序号并替换server-id
              SUFFIX=${HOSTNAME##*-}
              sed -i "s/server-id=1000/server-id=100${SUFFIX}/g" /etc/mysql/conf.d/my.cnf

              # 启动MySQL并配置复制
              mysqld &
              MYSQL_PID=$!

              # 等待MySQL启动
              until mysqladmin ping -uroot -p$MYSQL_ROOT_PASSWORD --silent; do
                sleep 2
              done

              # 设置主从复制
              mysql -uroot -p$MYSQL_ROOT_PASSWORD -e "
                CHANGE MASTER TO
                  MASTER_HOST='$MASTER_HOST',
                  MASTER_USER='$MASTER_USER',
                  MASTER_PASSWORD='$MASTER_PASSWORD',
                  MASTER_AUTO_POSITION=1;
                START SLAVE;
              "

              # 等待MySQL进程
              wait $MYSQL_PID
          resources:
            limits:
              cpu: "1"
              memory: "1Gi"
          livenessProbe:
            tcpSocket:
              port: 3306
            initialDelaySeconds: 30
            failureThreshold: 3
          readinessProbe:
            tcpSocket:
              port: 3306
            initialDelaySeconds: 5
            periodSeconds: 10
      volumes:
        - name: config
          configMap:
            name: mysql-slave-config  # Slave专用配置
  volumeClaimTemplates:
    - metadata:
        name: mysql-slave-pv  # 唯一名称
      spec:
        storageClassName: "standard"
        accessModes: [ReadWriteOnce]
        resources:
          requests:
            storage: 10Gi